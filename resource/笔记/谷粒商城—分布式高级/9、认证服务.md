# 一、环境搭建
````
1、创建gulimall-auth-server微服务

2、导入依赖

3、加入注册中心并开启远程调用

4、引入login.html和reg.html，

5、把 resource/静态资源/html/static/login 复制到 到 /mydata/nginx/html/static

6、修改C:\Windows\System32\drivers\etc 下的 hosts文件 192.168.48.129 auth.gulimall.com

7、网关配置路由

8、编写 WebConfig 添加视图跳转逻辑

登录：http://auth.gulimall.com/login.html
注册：http://auth.gulimall.com/reg.html
主页：http://gulimall.com/
````
# 二、邮箱注册、登录
## 1、第三方服务编写 qq邮箱发送验证码(代替阿里云短信发送验证码)
````
1、开启QQ邮箱传输协议服务

2、pom.xml配置邮箱服务依赖
<!--邮箱验证码验证-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
</dependency>

3、在nacos中添加邮箱配置 mail.yml
spring:
  mail:
    default-encoding: UTF-8
    username: 邮箱
    password: 当开启IMAP/SMTP后的一串密文密码
    host: smtp.qq.com

4、编写 /sms/sendcode 给其他服务调用使用用来发送短信
````
## 2、认证服务 gulimall-auth-server 调用第三方服务发送验证码
````
编写 /sms/sendCode 注册时向邮箱发送短信
````
## 3、接口防刷验证码的再次校验
````
1、gulimall-auth-server引入redis依赖

2、application.properties配置redis

3、common模块新增常量 AuthConstant

4、BizCodeEnum新增状态
SMS_DOCE_EXCEPTION(10002, "验证码频率太高, 稍后再试"),

5、修改 /sms/sendCode 接口
````
## 4、会员注册
````
1、认证模块 新增 UserRegistVo 实体类放到, 并使用 JSR303校验

2、会员模块 新增 MemberRegistVo 实体类

3、会员模块 新增 自定义异常 EmailExistException、UsernameExistException

4、BizCodeEnum新增状态
USER_EXIST_EXCEPTION(15001, "用户存在"),
EMAIL_EXIST_EXCEPTION(15002, "邮箱存在");
   
5、会员模块写 /register 实现会员注册

6、认证模块写 /register接口 实现注册(远程调用会员注册)
````
## 5、邮箱登录
````
1、认证模块 新建UserLoginVo

2、BizCodeEnum 新增状态码
LOGINACCT_PASWORD_EXCEPTION(15002, "账号密码错误");

3、会员模块 写/login 登录接口

4、认证模块 写/login 登录接口(远程调用会员模块的登录)
````
# 三、分布式session
## 1、分布式session解决方案
````
1、session复制: 用户登录后得到session后，服务把session也复制到别的机器上，显然这种处理很不好

2、hash一致性: 根据用户，到指定的机器上登录。但是远程调用还是不好解决

3、redis统一存储: 最终的选择方案，把session放到redis中
````
## 2、SpringSession整合redis
````
1、认证模块引入依赖
<dependency>
    <groupId>org.springframework.session</groupId>
    <artifactId>spring-session-data-redis</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>

2、修改配置
spring.session.store-type=redis
server.servlet.session.timeout=30m

3、启动类添加注解 添加注解 
@EnableRedisHttpSession //创建了一个springSessionRepositoryFilter ，负责将原生HttpSession 替换为Spring Session的实现

4、认证模块 写配置类 GulimallSessionConfig-(扩大session作用域) 

5、商品模块重复 1、2、3、4

6、认证模块改 /login接口 登录成功，设置session值

7、认证模块写 LoginController.loginPage() 判断是否已经登录
````
