# 一、性能指标
````
1、响应时间(Response Time:RT): 响应时间指用户从客户端发起一个请求开始,到客户端接收到从服务器端返回的响应结束,整个过程所耗费的时间。

2、HPS(Hits Per Second): 每秒点击次数,单位是次/秒。

3、TPS(Transaction per Second): 系统每秒处理交易数,单位是笔/秒。

4、QPS(Query per Second): 系统每秒处理查询次数,单位是次/秒。

5、对于互联网业务中,如果某些业务有且仅有一个请求连接,那么TPS=QPS=HPS,一般情况下用 TPS来衡量整个业务流程,用QPS来衡量接口查询次数,用HPS来表示对服务器单击请求。

6、无论TPS、QPS、HPS,此指标是衡量系统处理能力非常重要的指标,越大越好,根据经验,一般情况下:
		金融行业:1000TPS~5000OTPS,不包括互联网化的活动
		保险行业:100TPS~10000OTPS,不包括互联网化的活动
		制造行业:10TPS~5000TPS
		互联网电子商务:1000OTPS~1000000TPS
		互联网中型网站:1000TPS~50000TPS
		互联网小型网站:50OTPS~10000TPS

7、最大响应时间(MaxResponse Time): 指用户发出请求或者指令到系统做出反应(响应)的最大时间。

8、最少响应时间(Mininum ResponseTime): 指用户发出请求或者指令到系统做出反应(响应)的最少时间。

9、90%响应时间(90%Response Time)是指所有用户的响应时间进行排序,第90%的响应时间。

10、从外部看, 性能测试主要关注如下三个指标
    吞吐量: 每秒种系统能够处理的请求数、任务数。
    相应时间: 服务处理一个请求或一个任务的耗时。
    错误率: 一批请求中结果出错的请求所占比例。
````
# 二、Jmeter

## 1、下载

````
下载: https://jmeter.apache.org/download_jmeter.cgi

使用: 双击启动 apache-jmeter-5.4.1\bin\jmeter.bat
````

## 2、测试案例

````
1、新建测试计划

2、在测试计划下添加线程组(线程数==用户)
    线程数: 200
    循环次数: 100

3、在线程组下 添加-取样器-HTTP请求
    发送HTTP请求用法类似postman

4、在线程组下 添加-监听器-察看结果树

5、在线程组下 添加-监听器-汇总报告

6、在线程组下 添加-监听器-聚合报告

7、此时测试gulimall.com 2万次请求需要大约2分钟, 很慢

8、修改product微服务的JVM参数 -Xmx1024m -Xms1024m -Xmn512m, 此时测试gulimall.com 也很慢, 尚硅谷课程的JVM参数不太有效
````

## 3、win10没遇到 Jmeter Address Already in use错误
# 三、性能监控
## 1、测试nginx

````
1、新建线程组
    名称: nginx线程组
    线程数: 50
    循环次数: 永远
    
2、新建HTTP请求
    协议: http
    服务器名称或ip: 虚拟机ip
    端口号: 80
    HTTP请求: GET
    路径: /

3、在nginx线程组下添加 监听器-察看结果树、监听器-汇总报告、监听器-聚合报告

4、在虚拟机中使用 docker stats 监控性能

5、JMeter压测30秒查看性能
````
## 2、测试Gateway
````
1、新建线程组
    名称: Gateway线程组
    线程数: 50
    循环次数: 永远
    
2、新建HTTP请求
    协议: http
    服务器名称或ip: localhost
    端口号: 88
    HTTP请求: GET
    路径: /

3、在Gateway线程组下添加 监听器-察看结果树、监听器-汇总报告、监听器-聚合报告

4、在idea中用JProfiler启动网关模块

5、JMeter压测30秒查看性能
````
## 3、测试简单服务
````
1、新建线程组
    名称: 简单服务线程组
    线程数: 50
    循环次数: 永远
    
2、新建HTTP请求
    协议: http
    服务器名称或ip: localhost
    端口号: 10000
    HTTP请求: GET
    路径: /hello

3、在简单服务线程组下添加 监听器-察看结果树、监听器-汇总报告、监听器-聚合报告

4、在idea中用JProfiler启动Product模块

5、JMeter压测30秒查看性能
````
## 4、测试Gateway+简单服务
````
1、编写IndexController的hello

2、修改商品模块网关路由 
# 商品模块
- id: product_route
  uri: lb://gulimall-product
  predicates:
    - Path=/api/product/**,/hello
  filters:
    - RewritePath=/api/(?<segment>.*),/$\{segment}
    
3、新建线程组
    名称: Gateway+简单服务线程组
    线程数: 50
    循环次数: 永远
    
4、新建HTTP请求
    协议: http
    服务器名称或ip: localhost
    端口号: 88
    HTTP请求: GET
    路径: /hello

5、在Gateway+简单服务线程组下添加 监听器-察看结果树、监听器-汇总报告、监听器-聚合报告

6、JMeter压测30秒查看性能
````
## 5、测试全链路(Nginx+GateWay+简单服务)
````  
1、新建线程组
    名称: 全链路线程组
    线程数: 50
    循环次数: 永远
    
2、新建HTTP请求
    协议: http
    服务器名称或ip: gulimall.com
    端口号: 80
    HTTP请求: GET
    路径: /hello

3、在全链路线程组线程组下添加 监听器-察看结果树、监听器-汇总报告、监听器-聚合报告

4、JMeter压测30秒查看性能
````
## 6、测试首页一级菜单渲染
````  
1、新建线程组
    名称: 首页一级菜单渲染线程组
    线程数: 50
    循环次数: 永远
    
2、新建HTTP请求
    协议: http
    服务器名称或ip: localhost
    端口号: 10000
    HTTP请求: GET
    路径: /

3、在首页一级菜单渲染线程组下添加 监听器-察看结果树、监听器-汇总报告、监听器-聚合报告

4、在idea中用JProfiler启动Product模块

5、JMeter压测30秒查看性能
````
## 7、测试三级分类数据获取
````
1、新建线程组
    名称: 三级分类数据获取线程组
    线程数: 50
    循环次数: 永远
    
2、新建HTTP请求
    协议: http
    服务器名称或ip: localhost
    端口号: 10000
    HTTP请求: GET
    路径: /index/catalog.json

3、在三级分类数据获取线程组下添加 监听器-察看结果树、监听器-汇总报告、监听器-聚合报告

4、在idea中用JProfiler启动Product模块

5、JMeter压测30秒查看性能
````
## 8、测试首页全量数据获取
````
1、新建线程组
    名称: 首页一级菜单渲染线程组
    线程数: 50
    循环次数: 永远
    
2、新建HTTP请求
    协议: http
    服务器名称或ip: localhost
    端口号: 10000
    HTTP请求: GET
    路径: /
    在高级中勾选从HTML文件获取所有内含的资源, 设置并行下载数量为2(不设置JMeter会卡死)

3、在首页一级菜单渲染线程组下添加 监听器-察看结果树、监听器-汇总报告、监听器-聚合报告

4、在idea中用JProfiler启动Product模块

5、JMeter压测30秒查看性能
````
## 9、测试首页一级菜单渲染(thymeleaf开启缓存)
````
1、修改product模块的application.yml
thymeleaf:
    cache: true

2、新建线程组
    名称: 首页一级菜单渲染线程组
    线程数: 50
    循环次数: 永远
    
3、新建HTTP请求
    协议: http
    服务器名称或ip: localhost
    端口号: 10000
    HTTP请求: GET
    路径: /

4、在首页一级菜单渲染线程组下添加 监听器-察看结果树、监听器-汇总报告、监听器-聚合报告

5、在idea中用JProfiler启动Product模块

6、JMeter压测30秒查看性能
````
## 10、测试首页一级菜单渲染(thymeleaf开启缓存、优化数据库、关日志)
````
1、关日志 修改product模块的application.yml
logging:
  level:
    com.jch.gulimall.product: error

2、

2、新建线程组
    名称: 首页一级菜单渲染线程组
    线程数: 50
    循环次数: 永远
    
3、新建HTTP请求
    协议: http
    服务器名称或ip: localhost
    端口号: 10000
    HTTP请求: GET
    路径: /

4、在首页一级菜单渲染线程组下添加 监听器-察看结果树、监听器-汇总报告、监听器-聚合报告

5、在idea中用JProfiler启动Product模块

6、JMeter压测30秒查看性能
````
## 11、首页全量数据获取(nginx动静分离)
````
1、将static下文件 上传至 /mydata/nginx/html/

2、修改index.html的静态资源路径,加上static前缀
例: src="/static/index/img/img_09.png"

3、关闭thymeleaf缓存

4、修改/mydata/nginx/conf/conf.d/gulimall.conf
cd /mydata/nginx/conf/conf.d/
vi gulimall.conf
# 如果遇到有/static为前缀的请求,转发至html文件夹
location /static {
    root   /usr/share/nginx/html;
}


location / {
    proxy_pass http://gulimall;
    proxy_set_header Host $host;
}

5、重启nginx
docker restart nginx

6、访问http://gulimall.com/ 成功获取静态资源

7、新建线程组
    名称: 首页一级菜单渲染线程组
    线程数: 50
    循环次数: 永远
    
8、新建HTTP请求
    协议: http
    服务器名称或ip: gulimall.com
    端口号: 10000
    HTTP请求: GET
    路径: /
    在高级中勾选从HTML文件获取所有内含的资源, 设置并行下载数量为2(不设置JMeter会卡死)

9、在首页一级菜单渲染线程组下添加 监听器-察看结果树、监听器-汇总报告、监听器-聚合报告

10、在idea中用JProfiler启动Product模块

11、JMeter压测30秒查看性能
````
## 12、测试三级分类数据获取(优化三级分类)
````
1、优化前
对二级菜单的每次遍历都需要查询数据库,浪费大量资源

2、优化后
仅查询一次数据库,剩下的数据通过遍历得到并封装

3、新建HTTP请求
    协议: http
    服务器名称或ip: localhost
    端口号: 10000
    HTTP请求: GET
    路径: /index/catalog.json

4、在三级分类数据获取线程组下添加 监听器-察看结果树、监听器-汇总报告、监听器-聚合报告

5、在idea中用JProfiler启动Product模块

6、JMeter压测30秒查看性能
````
## 13、总结
|               压测内容                |压测线程数|       吞吐量/s        | 90%响应时间 | 99%响应时间 |
|:---------------------------------:|:-----:|:------------------:|:-------:|:-------:|
|           Nginx(浪费CPU)            |50|        1687        |   41    |   416   |
|          Gateway(浪费CPU)           |50|       10628        |    7    |   29    |
|            简单服务(返回字符串)            |50|       17651        |    5    |   14    |
|           Gateway+简单服务            |50|        3476        |   29    |   69    |
|      全链路(Nginx+GateWay+简单服务)      |50|        125         |  1019   |  7860   |
|             首页一级菜单渲染              |50| 310(db和thymeleaf慢) |   214   |   403   |
|      首页一级菜单渲染(thymeleaf开启缓存)      |50|        450         |   140   |   243   |
| 首页一级菜单渲染(thymeleaf开启缓存、优化数据库、关日志) |50|        1213        |   67    |   115   |
|             三级分类数据获取              |50|       9(db慢)       |  7472   |  8672   |
|             三级分类数据获取(优化业务)              |50|      200(db慢)      |   370   |   540   |
|             首页全量数据获取              |50|      25(静态资源)      |  2754   |  3364   |
|        首页全量数据获取(nginx动静分离)        |50|         30         |  2534   |  3198   |
## 14、优化
````
1、中间件越多,性能损失越大,大多都损失在网络交互了
2、业务: 优化DB(优化MYSQL)、模板的渲染速度(缓存)、静态资源
````
