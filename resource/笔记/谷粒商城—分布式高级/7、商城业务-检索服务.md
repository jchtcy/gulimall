# 一、搭建页面环境
````
1、search模块引入依赖
<!-- thymeleaf-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-thymeleaf</artifactId>
</dependency>

2、关闭thymeleaf的缓存

3、引入热部署

4、复制index.html到 src/main/resources/templates下

5、修改index.html文件, 静态资源加上前缀/static/search

6、将项目resource/静态资源/html/static下的 search 上传到 /mydata/nginx/html/static

7、修改 C:\Windows\System32\drivers\etc 下的 hosts文件
添加映射
192.168.48.129(虚拟机ip) search.gulimall.com

8、修改nginx的配置文件gulimall.conf
cd /mydata/nginx/conf/conf.d
vi gulimall.conf
# *.gulimall.com; 这种配置方式不包含gulimall.com
server_name  gulimall.com *.gulimall.com;

9、重启nginx
docker restart nginx

10、修改gulimall_host_route 网关路由
- id: gulimall_host_route
  uri: lb://gulimall-product
  predicates:
    - Host=gulimall.com
    
11、新增gulimall_search_route 网关路由
- id: gulimall_search_route
  uri: lb://gulimall-search
  predicates:
    - Host=search.gulimall.com
    
12、编写SearchController的indexPage跳转到首页

13、启动Gateway和search

14、此时访问 http://search.gulimall.com/
下半部分空白, 控制台报错, 这是因为直接复制别人现成的代码, controller还没返回数据所以报错, 继续往下写。
````
# 二、调整页面跳转
````
1、设置 谷粒商城首页 跳转到 http://gulimall.com

2、设置 谷粒商城logo 跳转到 http://gulimall.com

3、测试: 点击 谷粒商城首页和谷粒商城logo 都能跳转到谷粒商城首页

4、修改index.html 为list.html

5、SearchController的 indexPage, 返回的字符变为 list 

6、测试: 访问http://gulimall.com/ 在商城首页点击 手机分类, 跳转成功
````
# 三、商城检索
## 1、准备工作
````
1、检索条件分析
    全文检索: skuTitle
    排序: saleCount(销量)、hotScore(热度分)、skuPrice(价格)
    过滤: hasStock、skuPrice区间、brandId、catalog3Id、attrs
    聚合: atrrs
    
2、完整查询参数
    keyword=小米
    &sort=saleCount_desc/asc
    &hasStock=0/1
    &skuPrice=400_1900
    &brandId=1
    &catalog3Id=1
    &attrs=1_3G:4G:5G
    &attrs=2_骁龙845
    &attrs=4_高清屏

3、新建 SearchParam 来接收查询参数

4、新建 SearchResult 来给页面返回数据
````
## 2、ES检索规范
````
参与评分的全文检索放在must
不参与评分的放在filter
````
## 3、ES语句查询出需要的数据
````
GET product/_search
{
  "query": {
    "bool": {
      # 检索出华为
      "must": [
        {
          "match": {
            "skuTitle": "华为"
          }
        }
      ],
      # 过滤
      "filter": [
        {
          "term": {
            "catalogId": "225"
          }
        },
        {
          "terms": {
            "brandId": [
              "1",
              "2",
              "9"
            ]
          }
        },
        {
          "nested": {
            "path": "attrs",
            "query": {
              "bool": {
                "must": [
                  {
                    "term": {
                      "attrs.attrId": {
                        "value": "22"
                      }
                    }
                  },
                  {
                    "terms": {
                      "attrs.attrValue": [
                        "海思",
                        "以官网信息为准"
                      ]
                    }
                  }
                ]
              }
            }
          }
        },
        {
          "term": {
            "hasStock": {
              "value": "true"
            }
          }
        },
        {
          "range": {
            "skuPrice": { #价格在0-6000
              "gte": 0,
              "lte": 6000
            }
          }
        }
      ]
    }
  },
  "sort": [
    {
      "skuPrice": {
        "order": "desc"
      }
    }
  ],
  "from": 0,
  "size": 1,
  "highlight": {
    "fields": {
      "skuTitle": {} # 高亮字段
    },
    "pre_tags": "<b style='color:red'>",
    "post_tags": "</b>"
  },
  "aggs": {
    "brand_agg": {
      "terms": {
        "field": "brandId",
        "size": 10
      },
      "aggs": {
        "brand_name_agg": {
          "terms": {
            "field": "brandName",
            "size": 10
          }
        },
        "brand_img_agg": {
          "terms": {
            "field": "brandImg",
            "size": 10
          }
        }
      }
    },
    "catalog_agg": {
      "terms": {
        "field": "catalogId",
        "size": 10
      },
      "aggs": {
        "catalog_name_agg": {
          "terms": {
            "field": "catalogName",
            "size": 10
          }
        }
      }
    },
    "attr_agg": {
      "nested": {
        "path": "attrs"
      },
      "aggs": {
        "attr_id_agg": {
          "terms": {
            "field": "attrs.attrId",
            "size": 10
          },
          "aggs": {
            "attr_name_agg": {
              "terms": {
                "field": "attrs.attrName",
                "size": 10
              }
            },
            "attr_value_agg": {
              "terms": {
                "field": "attrs.attrValue",
                "size": 10
              }
            }
          }
        }
      }
    }
  }
}
````
# 四、DSL语句构建
````
MallSearchService 的 buildSearchRequest方法

1、查询
2、过滤
3、排序
4、分页
5、聚合
最后用postman测试
````
# 五、分析响应数据
````
1、返回的所有查询到的商品
2、当前商品涉及到所有属性信息
3、当前商品涉及到所有品牌信息
4、当前商品涉及到所有分类
5、分页信息

最后用postman测试
````
# 六、面包屑导航
````
1、SearchResult类新增属性 pageNavs、navs 、attrIds, 新增内部类内部类NavVo
2、SearchParam类新增属性 _queryString
3、MallSearchService的buildSearchResult方法在最后返回面包屑导航、构建面包屑导航数据_品牌、构建面包屑导航数据_分类
````
