# 一、准备工作
````
1、申请支付宝沙箱

2、内网穿透
````
# 二、集成支付宝支付
````
1、nacos新建配置文件 alipay.yml

2、order模块 加入配置中心 bootstrap.properties
spring.application.name=gulimall-order
spring.cloud.nacos.config.server-addr=127.0.0.1:8848

spring.cloud.nacos.config.extension-configs[0].data-id=alipay.yml
spring.cloud.nacos.config.extension-configs[0].group=DEFAULT_GROUP
spring.cloud.nacos.config.extension-configs[0].refresh=true

3、order模块 引入Java SDK（alipay-sdk-java）
<dependency>
  <groupId>com.alipay.sdk</groupId>
  <artifactId>alipay-sdk-java</artifactId>
  <version>4.34.0.ALL</version>
</dependency>

4、order模块新建 AlipayConfig  配置类

5、order模块新建 PayVO和PayAsyncVO

6、order模块写/payOrder 支付接口
````
# 三、支付成功跳转订单列表
````
1、订单服务新建 orderList.html

2、把 resource/静态资源/html/static/member 复制到 到 /mydata/nginx/html/static

3、OrderEntity新增
@TableField(exist = false)
private List<OrderItemEntity> orderItemEntityList;

4、订单服务写 /orderList.html 获取订单列表接口
````
# 四、支付成功的异步通知
````
1、内网穿透虚拟机 80端口

2、复制外网地址到nacos中 alipay.yml的notifyUrl

3、订单服务编写 /payOrder完成支付宝支付

4、订单服务编写 /orderList.html支付成功后跳转订单列表页面

5、订单服务编写 OrderPayListener收到支付宝通知时,返回处理结果给支付宝

6、nginx新增配置 映射支付成功的通知接口
server {
    listen       80;
    server_name  gulimall.com *.gulimall.com  3feff4ec.r27.cpolar.top;

    #charset koi8-r;
    #access_log  /var/log/nginx/log/host.access.log  main;
    
    location /static {
       root   /usr/share/nginx/html;
    }
    
    location /payed/notify {
       proxy_pass http://gulimall;
       proxy_set_header Host order.gulimall.com;
    }


7、修改订单服务登录拦截器 放行/payed/notify
````
